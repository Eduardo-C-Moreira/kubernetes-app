# ---------------------------
# Definição das etapas do pipeline
# O GitLab vai executar na ordem: build → test → package → deploy
# ---------------------------
stages:
  - build
  - test
  - package
  - deploy # NOVO ESTÁGIO

# ---------------------------
# Imagem Docker usada para rodar os comandos
# MUDANÇA: Usamos 'docker:latest' para permitir comandos Docker
# ---------------------------
image: docker:latest # Imagem principal alterada

# ---------------------------
# Variáveis de ambiente
# Aqui definimos que o repositório Maven será baixado localmente,
# evitando downloads repetidos e acelerando o pipeline.
# ---------------------------
variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  # Nome do seu repositório no Docker Hub: yyy/nome_do_app
  DOCKER_IMAGE_NAME: $DOCKER_USERNAME/seu_nome_do_app # ATENÇÃO: Mude 'seu_nome_do_app'

# ---------------------------
# Comandos executados antes de cada stage
# Apenas para conferência (versão do Java e Maven)
# ---------------------------
before_script:
  - echo "Java:"
  - java -version
  - mvn -version

# ==========================================================
#                       STAGE: BUILD
# ==========================================================
build:
  stage: build
  image: maven:3.9.6-eclipse-temurin-17 # Imagem Maven específica para este job
  script:
    - echo "Atualizando versão automaticamente..."
    - mvn versions:set -DnewVersion=1.0.$CI_PIPELINE_IID-$CI_COMMIT_SHORT_SHA
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - target/*.jar
      - pom.xml

# ==========================================================
#                       STAGE: TEST
# ==========================================================
test:
  stage: test
  image: maven:3.9.6-eclipse-temurin-17 # Imagem Maven específica para este job
  script:
    - mvn test

# ==========================================================
#                      STAGE: PACKAGE
# ==========================================================
package:
  stage: package
  image: maven:3.9.6-eclipse-temurin-17 # Imagem Maven específica para este job
  script:
    - echo "Versão final do build:"
    - mvn help:evaluate -Dexpression=project.version -q -DforceStdout
  artifacts:
    paths:
      - target/*.jar

# ==========================================================
#                       STAGE: DEPLOY
# ==========================================================
docker_push:
  stage: deploy
  image: docker:latest # Opcional, mas útil para jobs Docker
  services:
    - docker:dind # ESSENCIAL: Habilita Docker-in-Docker
  script:
    # 1. Obter a versão final criada no estágio BUILD
    - export PROJECT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
    - export IMAGE_FULL_TAG=$DOCKER_IMAGE_NAME:$PROJECT_VERSION

    # 2. Login no Docker Hub usando as variáveis de segurança (yyy e xx)
    # As variáveis DOCKER_USERNAME e DOCKER_PASSWORD devem ser configuradas no GitLab!
    - echo "Fazendo login no Docker Hub..."
    - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD

    # 3. Construir a imagem Docker
    # O seu Dockerfile deve estar na raiz do projeto.
#    - echo "Construindo imagem: $IMAGE_FULL_TAG"
    - docker build -t $IMAGE_FULL_TAG .

    # 4. Enviar a imagem para o Docker Hub
    - echo "Enviando imagem para o Docker Hub..."
    - docker push $IMAGE_FULL_TAG

    # Opcional: Enviar também com a tag 'latest'
    - docker tag $IMAGE_FULL_TAG $DOCKER_IMAGE_NAME:latest
    - docker push $DOCKER_IMAGE_NAME:latest

  # Este job só deve rodar se os estágios anteriores forem bem-sucedidos
  needs:
    - package

  # Adicione uma regra para rodar apenas em branches específicos, se desejar
  rules:
    - if: $CI_COMMIT_BRANCH == "master" # Ajuste para o seu branch de produção/deploy (ex: 'main', 'master')